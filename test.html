<html>
    <head>
        <title>jsonp test</title>
        <script src="http://code.jquery.com/jquery-1.6.2.min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.1/underscore-min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js"></script>
    </head>
    <body>
        <h1>The Strategy</h1>
        <ol>
            <li>We set up Backbone model to use jsonp</li>
            <li>The jsonp GET has user's choices in a backbone model</li>
            <li>Server generates _options partial</li>
            <li>Server does a <pre>compass compile --sass-dir /path/to/scss --css-dir /path/to/css --force</pre>generating our buttons.css</li>
            <li>Server then returns this buttons.css as a string in the jsonp response</li>
        </ol>
        <p><strong>You should be able to see this by breaking on the parse method and inspecting the response object</strong></p>
        <p><a href="#" id="testlink">Mutate Buttons Model (forces a backbone.sync)</a></p>

        <p>Here's a download test: </p>
        <p><input id='download' type=button value="Download" /></p>
    <script type="text/javascript">
    $(function() {
        var JsonpModel = Backbone.Model.extend({
            /**
             * We won't actually pollute our real models this way, but I'm
             * just using this to drive refactoring back-end to take /build/:module
             */
            module: 'buttons',
            /**
             * "sub-classes" of JsonpModel must override this
             * @type {String}
             */
            type: null,
            url: function() {
                // return 'http://options-compiler.herokuapp.com/build/buttons';
                return 'http://localhost:5000/build/'+this.module;
                // WE ARE NOW USING /build/:module
            },
            sync: function(method, model, options) {
                var url = model.url()+"?callback=?";
                var data = this.toJSON();
                console.log("URL: ", url);

                var params = _.extend({
                  type: 'GET',
                  dataType: 'jsonp',
                  data: data,
                  url: url
                }, options);

                // Make the request.
                return $.ajax(params);
            },
            parse: function(response) {
                // parse can be invoked for fetch and save, in case of save it can be undefined so check before using
                if (response && response[this.module]) {
                    return {
                        css: response[this.module],
                        optionsScss: response.optionsScss
                    };
                }
            }
        });

        var Buttons = JsonpModel.extend({
            type: 'buttons',
            defaults: {
                '$namespace': '.button',
                '$glow_namespace': '.glow',
                '$glow_color': '#2c9adb',
                '$bgcolor': '#EEE',
                '$height': '32px',
                '$font-color': '#666',
                '$font-size': '14px',
                '$font-weight': '300',
                '$font-family': "\"HelveticaNeue-Light\", \"Helvetica Neue Light\", \"Helvetica Neue\", Helvetica, Arial, \"Lucida Grande\", sans-serif",
                '$dropdown-background': '#fcfcfc',
                '$dropdown-link-color': '#333',
                '$dropdown-link-hover': '#FFF',
                '$dropdown-link-hover-background': '#3c6ab9',
                '$button_actions': {
                    'primary': '#00A1CB #FFF',
                    'action': '#7db500 #FFF',
                    'highlight': '#F18D05 #FFF',
                    'caution': '#E54028 #FFF',
                    'royal': '#87318C #FFF'
                    // ... define more as you please
                },
                '$button_styles': ['rounded', 'pill', 'circle'],
                '$button_sizes': ['large', 'small', 'tiny'],
                '$circle-size': '120px'
            }
        });
        var buttons = new Buttons();

        // Test straight up download using buttons.toJSON as our query string for window.open
        $('#download').click(function(e) {
            var url = 'http://localhost:5000/download/buttons?';
            var data = buttons.toJSON();
            url += $.param(data);
            console.log("URL: ", url);
            window.open(url, 'Download');
        });

        // Idea is we can define additional "modules" in same way; e.g. for Grids:
        // var Grids = JsonpModel.extend({ type: 'grids' .... });

        // When we click the testlink we mutate the backbone
        // model causing a jsonp sync so we can test this out
        $('#testlink').click(function(e) {
            // Set some custom properties on our buttons _options
            var actions = buttons.get('$button_actions');
            actions.primary = 'blue #fff';
            actions.action = 'green #fff';
            actions.silly = 'pink #fff';
            buttons.set({
                '$button_actions': actions,
                '$namespace': 'big-ole-butts',
                '$font-color': '#444'
            });
            // TODO: We'll probably move all this in to a backbone view and
            // listen for sync event
            buttons.save();
        });
    });
    </script>
    </body>
</html>
